#! /usr/bin/env python3
"""
Unit test for "Macro_Simulator.py"
"""

import Macro_Simulator

from optparse import OptionParser
import os
import sys
import unittest

from Common import Exit_Condition
import Halting_Lib
import IO
from IO import TM_Record
from Macro import Simulator, Turing_Machine
from Macro.Tape import INF
import TM_Enum

import io_pb2


class MacroSimulatorTest(unittest.TestCase):
  # Test that Macro_Simulator simulates known machines for the correct number
  # of steps and symbols.

  def setUp(self):
    # Get busy-beaver root directory.
    test_dir = os.path.dirname(sys.argv[0])
    self.root_dir = os.path.join(test_dir, os.pardir)
    self.root_dir = os.path.normpath(self.root_dir)
    # Setup default options.
    parser = OptionParser()
    Macro_Simulator.add_option_group(parser)
    self.options, args = parser.parse_args([])
    # Don't use time limits during test.
    self.options.time = 0

  def load_tm_record_filename(self, filename):
    tm = IO.load_tm(filename, 0)
    tm_enum = TM_Enum.TM_Enum(tm, allow_no_halt = False)
    return TM_Record.TM_Record(tm_enum = tm_enum)

  def test_bug_qhalt(self):
    # This machine failed:
    #   File ".../Code/Macro/Simulator.py", line 120, in calc_quasihalt
    #     if last_seen > q_state_last_seen:
    # while proving a rule because last_seen / q_state_last_seen were
    # Algebraic_Expressions.
    tm = IO.parse_tm("1RB1RC_0LC1LA_0LD1LB_0RD1RE_1LC0RA")
    tm = Turing_Machine.Backsymbol_Macro_Machine(tm)
    sim = Simulator.Simulator(tm, self.options)
    sim.loop_run(100)
    self.assertEqual(sim.op_state, Turing_Machine.INF_REPEAT)

  def test_bug_rec_diff(self):
    # This machine failed:
    #   File ".../Code/Macro/Proof_System.py", line 1113, in apply_diff_rule
    #     assert len(term.vars) == 1, term
    # AssertionError: 16 h j
    tm = IO.parse_tm("1RB1RD_1LC1RA_1RB1LD_1RE0LC_0LC0RA")
    tm = Turing_Machine.Block_Macro_Machine(tm, 2)
    tm = Turing_Machine.Backsymbol_Macro_Machine(tm)
    self.options.recursive = True
    sim = Simulator.Simulator(tm, self.options)
    # The failure happened at loop 919 on 7 Apr 2022.
    sim.loop_run(10_000)
    # Just make sure that we run long enough (and actually prove the rec rule)
    # we don't expect to actually prove the machine.

  def test_bug_rec_comp(self):
    # This machine failed:
    #   File ".../Code/Macro/Proof_System.py", line 1356, in config_is_above_min
    #     if current_val < min_val:
    # Algebraic_Expression.BadOperation
    tm = IO.parse_tm("1RB0LC_0RC0RD_1LA1RE_1RC0LE_0LD0RC")
    tm = Turing_Machine.Block_Macro_Machine(tm, 2)
    tm = Turing_Machine.Backsymbol_Macro_Machine(tm)
    self.options.recursive = True
    sim = Simulator.Simulator(tm, self.options)
    # The failure happened at loop 123 on 7 Apr 2022 (before fix).
    # TM is proven infinite at loop 333 (after fix).
    sim.loop_run(1000)
    self.assertEqual(sim.op_state, Turing_Machine.INF_REPEAT)

  def test_bug_rec_rule_mins(self):
    # See: https://github.com/sligocki/busy-beaver/issues/4
    tm = IO.parse_tm("1RB1LA_1RC0LE_1RD1LC_1LA0RF_1RD0LA_1RZ0RE")
    tm = Turing_Machine.Backsymbol_Macro_Machine(tm)
    self.options.recursive = True
    sim = Simulator.Simulator(tm, self.options)
    # TM was declared Halting (incorrect) at loop 96 on 26 Apr 2022 (before fix).
    # Then, same issue at loop 164 after partial fix.
    sim.loop_run(1000)
    self.assertNotEqual(sim.op_state, Turing_Machine.HALT)


  def test_small_halting(self):
    self.options.max_loops = 10_000
    # TODO(shawn): Should we just list the machine ttables directly instead?
    data = [("Machines/2x2-6-4", 6, 4),
            ("Machines/2x3-38-9", 38, 9),
            ("Machines/2x4-3932964-2050", 3932964, 2050),
            ("Machines/2x5-e21", 7069449877176007352687, 172312766455),
            ("Machines/3x2-14-6", 14, 6),
            ("Machines/3x2-21-5", 21, 5),
            ("Machines/3x3-e17", 119112334170342540, 374676383),
            ("Machines/4x2-107-13", 107, 13),
            ("Machines/5x2-47176870-4098", 47176870, 4098),
            ("Machines/6x2-1", 13122572797, 136612),
            ("Machines/6x2-Green", 436, 35),
            ]
    for name, expected_steps, expected_score in data:
      filename = os.path.join(self.root_dir, name)
      tm_record = self.load_tm_record_filename(filename)
      try:
        Macro_Simulator.run_options(tm_record, self.options)
      except:
        print("Error")
        print(name)
        raise
      self.assertFalse(tm_record.is_unknown_halting())
      self.assertTrue(tm_record.is_halting())
      self.assertEqual(Halting_Lib.get_big_int(tm_record.proto.status.halt_status.halt_steps),
                       expected_steps)
      self.assertEqual(Halting_Lib.get_big_int(tm_record.proto.status.halt_status.halt_score),
                       expected_score)

  def test_medium_halting(self):
    self.options.max_loops = 100_000
    data = [("Machines/2x5-e704",
             190282916614912976971178894914993423154449611310999556082522091580398024988179871263976771152617039324687422073674727556033765365815249814149279324440868411015096012479322048511264818866734215557976327245860530987070322862134260620002750847931226933305215449178921430294254511331593380579565596462250251756508571695291245917982611765119501158512949469897328673850184299624231030222372437154213503321136877877896606586851396019185159834879387000600955087580733165363673666786112829270952177017805116456278722546358429249188194516978022818365972073826588310015724870584042958950865442583137061907541982878261306211149968318903489501309660869300105000568503668204823982632164815051695298707924186734604934655, 17808374276114827179409165501110094347458953925524201057539295445498984038114371347629489952511050406043006585390507303594212813536645162904075575572206987865745833932117157019354966523037693527328238415191227013720305505859015489988006341788486725058461290508808960478051231024106456742446113814498720521570272294127488716030618060028602983180967071713),
            ("Machines/6x2-r",
             300232771652356282895510301834134018514775433724675250037338180173521424076038326588191208297820287669898401786071345848280422383492822716051848585583668153797251438618561730209415487685570078538658757304857487222040030769844045098871367087615079138311034353164641077919209890837164477363289374225531955126023251172259034570155087303683654630874155990822516129938425830691378607273670708190160525534077040039226593073997923170154775358629850421712513378527086223112680677973751790032937578520017666792246839908855920362933767744760870128446883455477806316491601855784426860769027944542798006152693167452821336689917460886106486574189015401194034857577718253065541632656334314242325592486700118506716581303423271748965426160409797173073716688827281435904639445605928175254048321109306002474658968108793381912381812336227992839930833085933478853176574702776062858289156568392295963586263654139383856764728051394965554409688456578122743296319960808368094536421039149584946758006509160985701328997026301708760235500239598119410592142621669614552827244429217416465494363891697113965316892660611709290048580677566178715752354594049016719278069832866522332923541370293059667996001319376698551683848851474625152094567110615451986839894490885687082244978774551453204358588661593979763935102896523295803940023673203101744986550732496850436999753711343067328676158146269292723375662015612826924105454849658410961574031211440611088975349899156714888681952366018086246687712098553077054825367434062671756760070388922117434932633444773138783714023735898712790278288377198260380065105075792925239453450622999208297579584893448886278127629044163292251815410053522246084552761513383934623129083266949377380950466643121689746511996847681275076313206, 12914951964730997250673433546819849509549358087128690053958730050912043114050444850240131432687888779698205017959267279467247759159594822175225305432481859864495796137909683447198447312843568880129905330630692235127777655264853382670979398926663934043364554169509365540834461843577841574296433860268929575034928793440722283883496539655948945100141899429447468817367569604813038150912656805487172475593041843712279467853624749989147054303748499093249845855395105658447844504456040960051641314951220524824061775814634738272664481030066727094186265135749803147803742486664009592180119421672821913958840123231130890028804306931645773916087727281493526404733170198979765603424776606833684409529730007044118561624874873652997002032667344587137859002909978872928814647043325481327200728882173015355211743620254438041767965892742035979306286763642267313721146548318330807873)
            ]
    for name, expected_steps, expected_score in data:
      filename = os.path.join(self.root_dir, name)
      tm_record = self.load_tm_record_filename(filename)
      try:
        Macro_Simulator.run_options(tm_record, self.options)
      except:
        print("Error")
        print(name)
        raise
      self.assertFalse(tm_record.is_unknown_halting())
      self.assertTrue(tm_record.is_halting())
      self.assertEqual(Halting_Lib.get_big_int(tm_record.proto.status.halt_status.halt_steps),
                       expected_steps)
      self.assertEqual(Halting_Lib.get_big_int(tm_record.proto.status.halt_status.halt_score),
                       expected_score)

  def test_large_halting(self):
    self.options.recursive = True
    self.options.compute_steps = False
    self.options.max_loops = 1_000_000
    self.options.max_block_size = 100
    # Stored in Hex to avoid https://docs.python.org/3/library/stdtypes.html#integer-string-conversion-length-limitation
    data = [("Machines/6x2-e21132-Pavel",
             0, 0x23dd6e98bcbd3d486558b053227375e06e1449a1ca752794ebd435aa751762282cf5920fd7cdf165e23e25488eeff47dcdac4097a6f2a756680eeccaf6f4504a942e8ff39f38c814eb1fd97239912f55f4a8bf2ada08a47632164c2c7518e1abd75c60437d6b7ec1dc0f3ced538ca096a39743c3e6cfce5cefd41497b02cf9e2a2384df7f5dafb6213c68c153a8d965a4be840a62dcd81bc2648f29bc11873e2d8280c5319a52906dec370012de3ab32f08e47c050259f2b89f10dbf9af33ea2f5d2ae6781c289b38578617e67ccbdd56876c870bd9990b3b8d79c2ba85ac6676dacf37d561b0e925012165178053f40a40c2068dbe026de9ca5c53dcffc67d072f2195ea6a49f3313262dbed57f095e68b5fbf7c396f65ddfe9b6b3eac5a77c4b814bcad057d2254de84c25a3d3f60e56906455f767f961bd43acda8b7eddd4bdad91b7605eb920d0e426b55658577b68ad4d069182b6a4b9d1fe3f3f4dbc08eaca236c1c50a1bb531df8062a4e4954c7261c871603a31320d84652e266fb225e58fd1e842a8ed46b8aec5ea3506bb7abb2ece9591ebfa9cd0053a23ab2b3a7c9e328bf1d5c657ab2e8e8aeecd33a31aef3c4ba38ec6cfe0d47aa855e2cfedf4efe4f8c2919e45a552c9692f71c9090c9023d9cdcc6af84b3238005396528a79b0b16c421d65fa05eb586d0bd4a653b0c1ef8713730ee2f9b02a59e5473b84780b8af3e7955df8dfac3ee2343ef32e7f50d98463360f7f4c4268f1d352f5e1f8bf32977a230dd044d35697506225af1eca4fbde14b7fbc12744c75918f21467717de33e19d281605a9d28243818b728688975633e58a8508e03d23a0102abf7024e20ab928bf424e4005e0c34faf8cd2350e5d66493c0727ce81103bd5ed4e4475ffffd0126c7a1c66f8e6c49e9597de48a744f1a9cf635e752140784e8d952ef9ec06eefa00fbbd4738f54839c22e7377e1101ca13a81534b26545650c57fb28845961775d395e6b3fda3ae48d22d89e7ad527e770309252bf569e44a756db42f707b08a3a494aac7451b85eba95ddfd78ac6d71e3bd4617ef6fcfee5c1255a370bcbe530a9a089d5e8208d2ab0f98c531a3f7a8e3741f48b8cc149a5a201d8dcf59038056eb3c68e6f117729c0c699f57622d569e94f6d7783606b55a6e272149589dfc360b55c03a2ad2d2467e7e35586cd69eff5d509f7820b60ed9da695c7daeca90d9247e0f8b31cc8d7d1b786fa37949ac5d006b099cfcd41187a26926d0c96bdb21c6aadb116535f1a253046260f75fb75e9e49cf0a89532dd8390462b9aa75ce768cda2e2919c56c67ffd47d0b8f09faa7722a29403ca162408590cb27ee74ab27efbc289a6697caeb07bc612a68544a83951845e2d5625dd340ad526899deb04d59dcec0058ae77501d1fc82b5809251f0ef3c5e2f705d2f713e4cfdca430180910add95f136f307f406c671b8bb2806ed7a5be5cf847b2f37ad99342e76cf2d6d8ec64cedaf5b19dbfec72620159718d1525c686c328e16ec8e3abf2f0b1d09fbd6484a3df4b3dac3f6e14b710fb73604b36d8934bf6edd83cf2cd49421671a96721c3d463ad25b6e874874a0e1d27181d6754bd404347b1dc1a496163fe5019925aaf00b6354a48a0c3eff1a197173b552a0e478b17f1bfdbee8187422e72cadb14e9fc16215c0a691776a6e9c36b2653968b9dd4becb35a06d7ac034a3c17d1aae583e0e207fa0aa28c648940664c18ebcf67214ba0f1115f5231dca121946cc6d3322ae2ac54f266b0a91ab1e6acfa0ca49c2a2696abe110f593a966600f92a3ce5cecbddb8f7db38dcf4fc843ad24ea2269424f599873efeeaea1d66c8f39f1a191a20fe9286df0a495794821804245023eec7d50c3f8ee25a8fb7e7766e28c2c7d1b5add016e87fb170dfefe2a070736c67ebeba10076fc2be15a4026736d63baef575cc5b92c70c584c8c7b2fa0f2b9407428e495487b5a19fdc38602004eb41c158a03c3f9d76722f06a386dc95a43c3c3b9a34265fc600fac0415e718f3f2367a82bba62d31ad75dc1b2367b5ca4022de9af69b2019e7d9a7f5d74e3714d525e122fee3cd4f7e1ab3da9b376f5c65505557ed8f3c5fe7c128df6889738828e68833e33cf658151bbd21f0d7fe92d6a956ab7079e7c23073b8a56a2ca34590a43d83fb61d9dadce5508a89a43f94ab5370a4ec5c4b12091471ce3c177a4e24b894c826524642031b1f3af7e73d19c6879f8a8c682aa6f2a8ed41869b3a20d643e759bd0fe6c243eabafa237b020c0de7f38f9251e93a9956cd9565b31debe0df524391c4056dc0bc215f9cc4772879e0c489c379bd45113d1cd51a256c9cac03db79b6bb115fb5878cfe90ccd786f62962e2dc0bc5354f60197033f0db69dada4aaf4f766a11901c148677246602276a01cee2541042ad410ae77e4d11c44659d290c4e7e628f2a33e2e0b31a5016650569fc5c2dae871826ac61865a9221ce806ff6773d469175b7838dff0fc8a536c68f512c38afeccb942727df7365a84251c2685a246c839a8c074b25c15f19c33113378d7e1cc5bc373214fbb3685f5c0c78442923fb9065feddc4e611158548838d0a5aac9f7f6289576f63ad15c432323874d776c8ffbb55d4bc4e1227f2d674d3f3656ceea3aca6f2de8ed54f55724300736be1382faebbd2cfeaf6f11181c4b9a5b3c75822d5bee14a30ee3005238dafa8ff24e28caca46f2db758c80cd53e4e0fc7634adb23bce5a5ee857b377c461d7fae21b6b2f34098868e499e37ffee0a53b111b3f38d088bd897156e9bc4a8f2fcde22e3985cfbc757ea21fd8000a6ccae470a43c2a10d6b468af59ebcf501e0b3c45b6d709c1915ca8f9bea93287705769d5fde37fe83c59e9ff5c89f5ed595fa2a189bb86a291b92d05baa057bf916f3adfd926898d55a60375a2e5dbfb67724108b000755c6edff3f96e5e875b850f81d8941e7b47154d07deaf9da1a90f2de34d83cdfc8e4adb6d641a33075a7271a2a0b49e8d761115ecc40509abad3d881d5b4df4dc0f2cc2174cc6b22d0d1e79d95eaf11359b0b429cadaa26cbe7a66401f31657b569fdfa020ee79aaff2be0abc2d843034d263bb1cca8f009d929aaddcb3df497bdbd3b6a7264301216a95bfe7b906a227d9c2acaca0d497b5cf8f0982c5af674f29ac8cedc8c8b2886c64df221715cf32dbd7bbc864b60ae9ff80fb84b004848cb1be104ec0755256ed701707574c7459f4fd03780aeede28bb8f50e5a628948dd86e892494c7a3e55e8fb883095057e2b6a79ff3a8a7f303544bbf799b3fec11938cd769f12e588c38aa56ba318a86dc3031a3a3d0d25e962eb4124d5d8a2ad36b79f87b5e507955da3dfc63c3003a482bdc2fe94f95fc47f19a0c295262c3af5b3594fc7955f1deea7a45f2c618a9519c4f014d970f65a62e7696c1732923d4877dd1b05670b27bf80256b3047e44b734acd05311481387de32e397827064fbc0549eee1ec5de14abdb74c45582ec5efcbe53adff5f352a3499f4aada828c84d0cfbf7f1585ae28839f9168f4dfa46547a7b4505496a7f97290d31a2d22122a421359de6daf6daea44bd4268f332b33b884373dcc0cb65ef10a54ab89e5b746042b42e30c9e64b6cdb90fd4355fd4e2537bf60ce581c3d87c7e9d87c164426b90a72e31a9cd89af347df757f0eccc4395375148874b9e70c39879f4f8c2404b69d0c63a810b70553d4d2f4039878e8016cf6ec3b3c8bcdbfc72bb496dbb5cfc82d55d37e1db5b5d5f141ff08b6184fb2098df74fc4f30e8f0dfd0d8d088a7a9351b5e29ddefa09b806a7dadaa0cb35329a99bd06137dda3e12ef72985400c178b2c077763257f0e81a922c5d53f04038487b05513ea5e7d5751871edc26c56dd01d50067775275d6d614bd1e7e9d1ad59fc5dad127b27698fae5ffdacc7867fbb7d16b828b349e54a0585911f0dab3aef5946bc73ecfb87e5056397159c82327b4d6e94565f8c13eed472a9247262a87f01a81566cb1be454b2ab79a4c68d31f79b8511f7daabbfdb073406388f8504b29f4eaa6a4190c1359c2489a0b883324501336417da9079d13c4f8cbe79cb57ee8f2051487a071df669c87920bf984bec71bcdf13447ad20cdb59ad4905cc75c1b2b0edbbe729ae5df44613be1e8fdbc07d1342f5bf72cf18396447a39d44b3f452f89045a5d4067019d1f2e9a4cc94db0a23605533bd054fd80892e29203411ac7784868ce268544d808599040a8ccdc9fd4113fbefc3d9dc8cf2863b0bcd1b9bb0106d8d47fc6ae4982f1b1e89e99be84799f9e665931504954b2a606b8ea6989f623cd61bd645f10cd2981542982bb76f3f73bc1d7fe1ca1f9985e1de6ba7a83a3ccdc9b8d83bf02117048b5f77981ec9282807e9b2cd263fc4298642745e3f694a2b1810503de4454c6326629cf4a6020066ea56b5e5b812d7545b3ad8237917e8f6747af1db7bdb02a6d252279081e090f59e50b9aaf2683f074443097e3b1adea523f79ffa34a44cee31fd2587940998a488c37b72c48ab43f0563d2c00cdb639fa435d611d98d3ae6db9696f246286efc7ca6942b439cbf3fb38904499fbce1fc60423a0c418458b720a13efed00466e4bda80eda2230b8102ada73a7df89ca0fc875bcf1022d711d64c038c40ee592372296414261b64073deab0d40e8da23f11be280c255f2ffd3e5d307ede4283a6a773357aa5f97c05327e2170a0d43aeca50cf8d8adc2f193055725d0a7e957c33729c36563e79b16818632b555a47454d356595c8edefc36fd7f7ab98502f459beb2a4d18ec07e757c7655474c658b67b6c7de116510330b7fd81910258ead24e5cadf0375b47b016aaada99a4266124131643f3cf0777b73cce4260e280d37b5023d278078b90a986b6eda22d3d7f6a8f3581a91c2aa020102557435100c546f1d99c67226bc4d74f319ab11bd309793d4e8ee1dfce7f48d4b748bdfa13dc09301f6dde3d0b221b1139feb390c47bdf281b1119e47f928cb97c8ea68d6b5c948e9f632cd98a767ec18e5ffc9dd919dee7f55b250ff959115383d4ae638b8b34493e63737ff6596ba1013081a84906ddcd392ab0e97130111001903b90c29f3cdc578638fc330b713e12a726354534c86677e6be05ea910cf4d7f2e9ede04769cd52c8961638458726870867399f953de9ce4cb505d5303653ca868510a1c6b4a4f65f6f792e153295fe0a1237538336e5a64a2e3001491100804c2288522d06b0495f0c0b41c92aa4a1292cb3c916b0675b1eb3ca2177626bc0beedc4044bd3b370cb41eddcc1a40d500c7c5f0ff11e320a4c05199a91b4e53002ffb41d0c96bbc204690336e2f262b80eb7dc535f842559b30078f7d5b036b550d98acbcf681605fc180fd1e08b405db75d1f006cfc848bd89ab6d8cc2bc8126f014dfe38f92c7702a0502831ed37c5197920915e43054f825aac059f4246f3aae0493667bab676a278129fed9845fbb6f7ac7529efcd82147461bdd82f398cc9d20a9e277d0a26262ffa9ebbb5221f80374ffa0c91dcb2f1621ae166d6686b508dfaeb43cfd24235e36b31624de13f9c65d17ad2c4ffd1fda79d672be35dfdfc19cbc74eb15e48d97437d6498d9b914cccfa5382afd6498972948562ef6ca252174fb98a0f23efdc0ecace6b6b02dd7ca5e0fbaaeb05b987a5461e28ab9ee8fa9dae06fdf107f589f5f633784264d5b954f096d82177e2805b4cf08d070406ae28afab2af1bdea10a3e5a1fc0f721387cd869710b9eb3c2750bee5b0aff2fff143647d7cec89323d744a13a23aedd954098a9edd4037312f90b246d5ab0e1c1e21e5f914525da29f241dc050b2d05af91d893f2106ffb3c5c4bec5ca3d84a04bcfcc49eaa3450c7325798cd72be1316d82281925c5fd3e3fe8d4d6caac61b97c8b21e3bd7834b8928fc4145a3e7f8a55c3274696b13ac66af99067216ab39454f932afc852421ddf2671102d857363992bc2dc553e4ce85823b01724ddd44ee807c63c67974d4eefd5f2503177db1a41117bfcb83dd589d95c9f992318f47cb94b20c7700b1a9566d633dded19c6869ee0253bc157aa2fbcea4979b5ddb69a82bf973101530184698f771a5b6ccf27f4403c2c8e499f8b682e833d2b0c7dc7b25ea8a79c31fead4c06e99a2abce1cfe617cca031a),
            ("Machines/6x2-e36534-Pavel",
             0, 0xb1c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71c71f),
            ]
    for name, expected_steps, expected_score in data:
      filename = os.path.join(self.root_dir, name)
      tm_record = self.load_tm_record_filename(filename)
      try:
        Macro_Simulator.run_options(tm_record, self.options)
      except:
        print("Error")
        print(name)
        raise
      self.assertFalse(tm_record.is_unknown_halting())
      self.assertTrue(tm_record.is_halting())
      self.assertEqual(Halting_Lib.get_big_int(tm_record.proto.status.halt_status.halt_steps),
                       expected_steps)
      self.assertEqual(Halting_Lib.get_big_int(tm_record.proto.status.halt_status.halt_score),
                       expected_score)

  def test_non_halting(self):
    self.options.recursive = True
    tm = IO.parse_tm("1RB---2LA_2LB2RA0LB")
    tm_enum = TM_Enum.TM_Enum(tm, allow_no_halt = False)
    tm_record = TM_Record.TM_Record(tm_enum = tm_enum)
    simulated_result = Macro_Simulator.run_options(tm_record, self.options)

    # Non halting
    self.assertFalse(tm_record.is_unknown_halting())
    self.assertFalse(tm_record.is_halting())
    self.assertEqual(tm_record.proto.status.halt_status.inf_reason,
                     io_pb2.INF_CTL)

if __name__ == '__main__':
  unittest.main()
